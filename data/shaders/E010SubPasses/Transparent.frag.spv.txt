Transparent.frag
// Module Version 10000
// Generated by (magic number): 80008
// Id's are bound by 80

                              Capability Shader
                              Capability InputAttachment
               2:             ExtInstImport  "GLSL.std.450"
                              MemoryModel Logical GLSL450
                              EntryPoint Fragment 5  "main" 51 61 75 79
                              ExecutionMode 5 OriginUpperLeft
               1:             String  "Transparent.frag"
                              Source GLSL 450 1  "// OpModuleProcessed client vulkan100
// OpModuleProcessed target-env vulkan1.0
// OpModuleProcessed entry-point main
#line 1
#version 450

layout (input_attachment_index = 0, set = 2, binding = 0) uniform subpassInput inputPosition;

layout(set=2, binding=1) uniform sampler2D baseTexture;

layout (location = 0) in vec3 inColor;
layout (location = 1) in vec2 inUV;

layout (location = 0) out vec4 outColor;

#define NEAR_PLANE 0.1f
#define FAR_PLANE 256.0f

float linearDepth(float depth)
{
	float z = depth * 2.0f - 1.0f; 
	return (2.0f * NEAR_PLANE * FAR_PLANE) / (FAR_PLANE + NEAR_PLANE - z * (FAR_PLANE - NEAR_PLANE));	
}

void main() {

	// Sample depth from deferred depth buffer and discard if obscured
	float depth = subpassLoad(inputPosition).a;

	// Save the sampled texture color before discarding.
	// This is to avoid implicit derivatives in non-uniform control flow.
	vec4 sampledColor = texture(baseTexture, inUV);
	if ((depth != 0.0) && (linearDepth(gl_FragCoord.z) > depth))
	{
		discard;
	};

	outColor = sampledColor;
}
"
                              Name 5  "main"
                              Name 11  "linearDepth(f1;"
                              Name 10  "depth"
                              Name 13  "z"
                              Name 28  "depth"
                              Name 31  "inputPosition"
                              Name 43  "sampledColor"
                              Name 47  "baseTexture"
                              Name 51  "inUV"
                              Name 61  "gl_FragCoord"
                              Name 62  "param"
                              Name 75  "outColor"
                              Name 79  "inColor"
                              Decorate 31(inputPosition) DescriptorSet 2
                              Decorate 31(inputPosition) Binding 0
                              Decorate 31(inputPosition) InputAttachmentIndex 0
                              Decorate 47(baseTexture) DescriptorSet 2
                              Decorate 47(baseTexture) Binding 1
                              Decorate 51(inUV) Location 1
                              Decorate 61(gl_FragCoord) BuiltIn FragCoord
                              Decorate 75(outColor) Location 0
                              Decorate 79(inColor) Location 0
               3:             TypeVoid
               4:             TypeFunction 3
               7:             TypeFloat 32
               8:             TypePointer Function 7(float)
               9:             TypeFunction 7(float) 8(ptr)
              15:    7(float) Constant 1073741824
              17:    7(float) Constant 1065353216
              19:    7(float) Constant 1112329421
              20:    7(float) Constant 1132465357
              22:    7(float) Constant 1132455526
              29:             TypeImage 7(float) SubpassData nonsampled format:Unknown
              30:             TypePointer UniformConstant 29
31(inputPosition):     30(ptr) Variable UniformConstant
              33:             TypeInt 32 1
              34:     33(int) Constant 0
              35:             TypeVector 33(int) 2
              36:   35(ivec2) ConstantComposite 34 34
              37:             TypeVector 7(float) 4
              39:             TypeInt 32 0
              40:     39(int) Constant 3
              42:             TypePointer Function 37(fvec4)
              44:             TypeImage 7(float) 2D sampled format:Unknown
              45:             TypeSampledImage 44
              46:             TypePointer UniformConstant 45
 47(baseTexture):     46(ptr) Variable UniformConstant
              49:             TypeVector 7(float) 2
              50:             TypePointer Input 49(fvec2)
        51(inUV):     50(ptr) Variable Input
              54:             TypeBool
              56:    7(float) Constant 0
              60:             TypePointer Input 37(fvec4)
61(gl_FragCoord):     60(ptr) Variable Input
              63:     39(int) Constant 2
              64:             TypePointer Input 7(float)
              74:             TypePointer Output 37(fvec4)
    75(outColor):     74(ptr) Variable Output
              77:             TypeVector 7(float) 3
              78:             TypePointer Input 77(fvec3)
     79(inColor):     78(ptr) Variable Input
         5(main):           3 Function None 4
               6:             Label
       28(depth):      8(ptr) Variable Function
43(sampledColor):     42(ptr) Variable Function
       62(param):      8(ptr) Variable Function
                              Line 1 24 0
              32:          29 Load 31(inputPosition)
              38:   37(fvec4) ImageRead 32 36
              41:    7(float) CompositeExtract 38 3
                              Store 28(depth) 41
                              Line 1 28 0
              48:          45 Load 47(baseTexture)
              52:   49(fvec2) Load 51(inUV)
              53:   37(fvec4) ImageSampleImplicitLod 48 52
                              Store 43(sampledColor) 53
                              Line 1 29 0
              55:    7(float) Load 28(depth)
              57:    54(bool) FOrdNotEqual 55 56
                              SelectionMerge 59 None
                              BranchConditional 57 58 59
              58:               Label
              65:     64(ptr)   AccessChain 61(gl_FragCoord) 63
              66:    7(float)   Load 65
                                Store 62(param) 66
              67:    7(float)   FunctionCall 11(linearDepth(f1;) 62(param)
              68:    7(float)   Load 28(depth)
              69:    54(bool)   FOrdGreaterThan 67 68
                                Branch 59
              59:             Label
              70:    54(bool) Phi 57 6 69 58
                              SelectionMerge 72 None
                              BranchConditional 70 71 72
              71:               Label
                                Line 1 31 0
                                Kill
              72:             Label
                              Line 1 34 0
              76:   37(fvec4) Load 43(sampledColor)
                              Store 75(outColor) 76
                              Return
                              FunctionEnd
11(linearDepth(f1;):    7(float) Function None 9
       10(depth):      8(ptr) FunctionParameter
              12:             Label
           13(z):      8(ptr) Variable Function
                              Line 1 17 0
              14:    7(float) Load 10(depth)
              16:    7(float) FMul 14 15
              18:    7(float) FSub 16 17
                              Store 13(z) 18
                              Line 1 18 0
              21:    7(float) Load 13(z)
              23:    7(float) FMul 21 22
              24:    7(float) FSub 20 23
              25:    7(float) FDiv 19 24
                              ReturnValue 25
                              FunctionEnd
